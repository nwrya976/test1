<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>📋 إدارة المشاريع والعمال - نسخة سريعة</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body { 
        font-family: 'Cairo', sans-serif;
        direction: rtl; 
        background: #1a1a2e;
        color: #eee;
        padding: 10px; 
        min-height: 100vh;
        line-height: 1.5;
    }
    
    .container { 
        max-width: 800px;
        margin: auto; 
        background: #16213e;
        padding: 20px;
        border-radius: 10px; 
        margin-top: 20px;
    }

    h1, h2, h3 { 
        text-align: center;
        color: #4fc3f7;
        margin-bottom: 15px;
    }

    input, select, textarea { 
        margin: 5px 0;
        padding: 8px; 
        width: 100%; 
        border: 1px solid #333; 
        border-radius: 5px; 
        background: #0f3460;
        color: #fff;
        font-size: 14px;
    }

    button { 
        background: #4fc3f7;
        color: #000;
        cursor: pointer; 
        font-weight: 600;
        margin: 5px 0;
        padding: 10px;
        width: 100%;
        border: none;
        border-radius: 5px;
        font-size: 14px;
    }
    
    button:hover {
        background: #29b6f6;
    }
    
    button.delete {
        background: #f44336;
        color: #fff;
    }
    
    button.delete:hover {
        background: #d32f2f;
    }

    table { 
        width: 100%; 
        border-collapse: collapse;
        margin-top: 15px; 
        font-size: 13px;
    }
    
    th, td { 
        border: 1px solid #333;
        padding: 8px; 
        text-align: center; 
    }
    
    th { 
        background: #0f3460;
    }

    .report { 
        margin-top: 15px;
        padding: 15px; 
        background: #0f3460; 
        border-radius: 8px;
    }

    .project-card {
        background: #0f3460;
        padding: 15px;
        margin: 10px 0;
        cursor: pointer;
        border-radius: 8px;
        border: 1px solid #333;
    }

    .project-card:hover {
        background: #1565c0;
    }

    .hidden {
        display: none;
    }

    .inline-buttons { 
        display: flex;
        gap: 5px; 
    }
    
    .inline-buttons button { 
        flex: 1;
    }

    .success {
        background: #4caf50;
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        text-align: center;
    }

    .error {
        background: #f44336;
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        text-align: center;
    }

    @media(max-width: 600px) {
        .container {
            padding: 15px;
            margin: 10px 5px;
        }
        
        input, button {
            font-size: 16px; /* منع zoom في iOS */
        }
        
        table {
            font-size: 12px;
        }
        
        th, td {
            padding: 5px;
        }
    }
</style>
</head>

<body>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- صفحة تسجيل الدخول -->
<div class="container" id="authPage">
    <h1>📋 تسجيل الدخول</h1>
    
    <div id="message"></div>

    <input type="email" id="email" placeholder="البريد الإلكتروني" required>
    <input type="password" id="password" placeholder="كلمة المرور" required>
    
    <button id="loginBtn">دخول</button>
    <button id="signupBtn" style="background: #666;">إنشاء حساب</button>
    
    <p style="text-align: center; margin-top: 15px;">
        <span id="toggleText">ليس لديك حساب؟</span> 
        <a href="#" id="toggleLink" style="color: #4fc3f7;">اضغط هنا</a>
    </p>
</div>

<!-- التطبيق الرئيسي -->
<div class="container hidden" id="mainPage">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>مرحبا <span id="userName"></span></h2>
        <button id="logoutBtn" style="width: auto; padding: 8px 15px; background: #666;">خروج</button>
    </div>

    <!-- قائمة المشاريع -->
    <div id="projectsList">
        <h2>🏗️ المشاريع</h2>
        
        <button onclick="showAddProject()">➕ مشروع جديد</button>
        
        <div id="addProjectForm" class="hidden" style="margin: 15px 0; padding: 15px; background: #0f3460; border-radius: 8px;">
            <input type="text" id="newProjectName" placeholder="اسم المشروع">
            <div class="inline-buttons">
                <button onclick="addProject()">إضافة</button>
                <button onclick="hideAddProject()" style="background: #666;">إلغاء</button>
            </div>
        </div>

        <div id="projectsContainer"></div>
    </div>

    <!-- تفاصيل المشروع -->
    <div id="projectDetails" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="backToProjects()" style="width: auto; padding: 8px 15px; background: #666;">← رجوع</button>
            <h2 id="projectTitle">تفاصيل المشروع</h2>
            <div class="inline-buttons" style="width: auto;">
                <button onclick="shareProject()" style="width: auto; padding: 8px 15px; background: #4caf50;">مشاركة</button>
                <button onclick="deleteProject()" style="width: auto; padding: 8px 15px;" class="delete">حذف</button>
            </div>
        </div>

        <!-- إضافة عامل -->
        <h3>➕ إضافة عامل</h3>
        <input type="text" id="workerName" placeholder="اسم العامل">
        <input type="number" id="workerPhone" placeholder="رقم الهاتف">
        <input type="number" id="workerWage" placeholder="الأجرة اليومية">
        <button onclick="addWorker()">إضافة العامل</button>

        <!-- جدول العمال -->
        <h3>📊 العمال</h3>
        <table id="workersTable">
            <thead>
                <tr>
                    <th>الاسم</th>
                    <th>الأجرة</th>
                    <th>الأيام</th>
                    <th>المستحق</th>
                    <th>العمليات</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- الحضور -->
        <h3>📝 الحضور</h3>
        <input type="text" id="attendanceName" placeholder="اسم العامل">
        <div class="inline-buttons">
            <button onclick="addAttendance(1)">يوم كامل</button>
            <button onclick="addAttendance(0.5)">نصف يوم</button>
        </div>

        <!-- الدفع -->
        <h3>💰 دفع راتب</h3>
        <input type="text" id="paymentName" placeholder="اسم العامل">
        <input type="number" id="paymentAmount" placeholder="المبلغ">
        <button onclick="makePayment()">دفع</button>

        <!-- التقارير -->
        <h3>📑 التقارير</h3>
        <input type="text" id="reportName" placeholder="اسم العامل (اختياري)">
        <div class="inline-buttons">
            <button onclick="showReport()">تقرير محدد</button>
            <button onclick="showAllReports()">كل التقارير</button>
        </div>
        
        <div id="reportsContainer"></div>
    </div>
</div>

<script>
    // إعدادات Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDye4DgqNvEwwWDYf1yjW5yfJc14p1LmiU",
        authDomain: "your-project-10fbe.firebaseapp.com",
        databaseURL: "https://your-project-10fbe-default-rtdb.firebaseio.com",
        projectId: "your-project-10fbe",
        storageBucket: "your-project-10fbe.firebasestorage.app",
        messagingSenderId: "715972050011",
        appId: "1:715972050011:web:d5a4507dcfc30fa779d37e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    
    // متغيرات عامة
    let currentUser = null;
    let projects = [];
    let currentProject = null;
    let isViewOnly = false;
    let isLoginMode = true;

    // عناصر الصفحة
    const authPage = document.getElementById('authPage');
    const mainPage = document.getElementById('mainPage');
    const message = document.getElementById('message');

    // فحص المشاركة
    function checkShareLink() {
        const params = new URLSearchParams(window.location.search);
        const projectId = params.get('project');
        const userId = params.get('user');
        
        if (projectId && userId) {
            isViewOnly = true;
            loadSharedProject(userId, projectId);
            return true;
        }
        return false;
    }

    // تسجيل الدخول
    auth.onAuthStateChanged(user => {
        if (checkShareLink()) return;
        
        if (user) {
            currentUser = user;
            showMainPage();
            loadProjects();
        } else {
            showAuthPage();
        }
    });

    function showMessage(text, isError = false) {
        message.innerHTML = `<div class="${isError ? 'error' : 'success'}">${text}</div>`;
        setTimeout(() => message.innerHTML = '', 3000);
    }

    function showAuthPage() {
        authPage.classList.remove('hidden');
        mainPage.classList.add('hidden');
    }

    function showMainPage() {
        authPage.classList.add('hidden');
        mainPage.classList.remove('hidden');
        document.getElementById('userName').textContent = currentUser.email.split('@')[0];
    }

    // التبديل بين تسجيل الدخول والتسجيل
    document.getElementById('toggleLink').onclick = function(e) {
        e.preventDefault();
        isLoginMode = !isLoginMode;
        
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const toggleText = document.getElementById('toggleText');
        
        if (isLoginMode) {
            loginBtn.style.display = 'block';
            signupBtn.style.display = 'none';
            toggleText.textContent = 'ليس لديك حساب؟';
        } else {
            loginBtn.style.display = 'none';
            signupBtn.style.display = 'block';
            toggleText.textContent = 'لديك حساب؟';
        }
    };

    // تسجيل الدخول
    document.getElementById('loginBtn').onclick = function() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            showMessage('املأ كل الحقول', true);
            return;
        }

        auth.signInWithEmailAndPassword(email, password)
            .then(() => showMessage('تم تسجيل الدخول'))
            .catch(() => showMessage('خطأ في البيانات', true));
    };

    // إنشاء حساب
    document.getElementById('signupBtn').onclick = function() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            showMessage('املأ كل الحقول', true);
            return;
        }

        if (password.length < 6) {
            showMessage('كلمة المرور قصيرة', true);
            return;
        }

        auth.createUserWithEmailAndPassword(email, password)
            .then(() => showMessage('تم إنشاء الحساب'))
            .catch(() => showMessage('البريد مستخدم', true));
    };

    // تسجيل الخروج
    document.getElementById('logoutBtn').onclick = function() {
        auth.signOut();
    };

    // تحميل المشاريع
    function loadProjects() {
        if (!currentUser) return;
        
        database.ref(`workmanProjects/${currentUser.uid}`).on('value', snapshot => {
            const data = snapshot.val();
            projects = [];
            if (data) {
                projects = Object.keys(data).map(key => ({
                    id: key,
                    ...data[key]
                }));
            }
            displayProjects();
        });
    }

    function displayProjects() {
        const container = document.getElementById('projectsContainer');
        container.innerHTML = '';
        
        if (projects.length === 0) {
            container.innerHTML = '<p>لا توجد مشاريع</p>';
            return;
        }

        projects.forEach(p => {
            const workers = p.workers || [];
            const totalWorkers = workers.length;
            const totalOwed = workers.reduce((sum, w) => {
                const due = (w.days || 0) * (w.wage || 0);
                const paid = (w.payments || []).reduce((s, pay) => s + pay.amount, 0);
                return sum + (due - paid);
            }, 0);

            const div = document.createElement('div');
            div.className = 'project-card';
            div.innerHTML = `
                <h3>${p.name}</h3>
                <p>العمال: ${totalWorkers} | المستحق: ${totalOwed.toLocaleString()}</p>
            `;
            div.onclick = () => openProject(p);
            container.appendChild(div);
        });
    }

    // إضافة مشروع
    function showAddProject() {
        document.getElementById('addProjectForm').classList.remove('hidden');
    }

    function hideAddProject() {
        document.getElementById('addProjectForm').classList.add('hidden');
        document.getElementById('newProjectName').value = '';
    }

    function addProject() {
        const name = document.getElementById('newProjectName').value.trim();
        if (!name) return;

        database.ref(`workmanProjects/${currentUser.uid}`).push({
            name: name,
            workers: []
        }).then(() => {
            showMessage('تم إضافة المشروع');
            hideAddProject();
        });
    }

    // فتح المشروع
    function openProject(project) {
        currentProject = project;
        document.getElementById('projectTitle').textContent = project.name;
        document.getElementById('projectsList').classList.add('hidden');
        document.getElementById('projectDetails').classList.remove('hidden');
        updateWorkersTable();
    }

    function backToProjects() {
        if (isViewOnly) {
            window.close();
            return;
        }
        document.getElementById('projectsList').classList.remove('hidden');
        document.getElementById('projectDetails').classList.add('hidden');
        currentProject = null;
    }

    // إضافة عامل
    function addWorker() {
        if (!currentProject || isViewOnly) return;

        const name = document.getElementById('workerName').value.trim();
        const phone = document.getElementById('workerPhone').value.trim();
        const wage = parseFloat(document.getElementById('workerWage').value);

        if (!name || !phone || !wage) {
            showMessage('املأ كل الحقول', true);
            return;
        }

        if (!currentProject.workers) currentProject.workers = [];
        currentProject.workers.push({
            name: name,
            phone: phone,
            wage: wage,
            days: 0,
            attendance: [],
            payments: []
        });

        database.ref(`workmanProjects/${currentUser.uid}/${currentProject.id}`).set(currentProject)
            .then(() => {
                showMessage('تم إضافة العامل');
                document.getElementById('workerName').value = '';
                document.getElementById('workerPhone').value = '';
                document.getElementById('workerWage').value = '';
                updateWorkersTable();
            });
    }

    // تحديث جدول العمال
    function updateWorkersTable() {
        const tbody = document.querySelector('#workersTable tbody');
        tbody.innerHTML = '';

        if (!currentProject.workers) return;

        currentProject.workers.forEach((worker, index) => {
            const totalDue = (worker.days || 0) * (worker.wage || 0);
            const totalPaid = (worker.payments || []).reduce((sum, p) => sum + p.amount, 0);
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${worker.name}</td>
                <td>${worker.wage}</td>
                <td>${worker.days || 0}</td>
                <td>${totalDue}</td>
                <td>
                    ${!isViewOnly ? `<button class="delete" onclick="removeWorker(${index})" style="width: auto; padding: 5px 10px;">حذف</button>` : ''}
                </td>
            `;
        });
    }

    // حذف عامل
    function removeWorker(index) {
        if (confirm('حذف العامل؟')) {
            currentProject.workers.splice(index, 1);
            database.ref(`workmanProjects/${currentUser.uid}/${currentProject.id}`).set(currentProject)
                .then(() => {
                    showMessage('تم الحذف');
                    updateWorkersTable();
                });
        }
    }

    // الحضور
    function addAttendance(value) {
        if (isViewOnly) return;
        
        const name = document.getElementById('attendanceName').value.trim();
        if (!name) return;

        const worker = currentProject.workers.find(w => w.name === name);
        if (!worker) {
            showMessage('العامل غير موجود', true);
            return;
        }

        worker.days = (worker.days || 0) + value;
        if (!worker.attendance) worker.attendance = [];
        worker.attendance.push({
            date: new Date().toLocaleDateString(),
            value: value
        });

        database.ref(`workmanProjects/${currentUser.uid}/${currentProject.id}`).set(currentProject)
            .then(() => {
                showMessage(`تم تسجيل ${value} يوم`);
                document.getElementById('attendanceName').value = '';
                updateWorkersTable();
            });
    }

    // الدفع
    function makePayment() {
        if (isViewOnly) return;
        
        const name = document.getElementById('paymentName').value.trim();
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        
        if (!name || !amount) return;

        const worker = currentProject.workers.find(w => w.name === name);
        if (!worker) {
            showMessage('العامل غير موجود', true);
            return;
        }

        if (!worker.payments) worker.payments = [];
        worker.payments.push({
            amount: amount,
            date: new Date().toLocaleDateString()
        });

        database.ref(`workmanProjects/${currentUser.uid}/${currentProject.id}`).set(currentProject)
            .then(() => {
                showMessage('تم الدفع');
                document.getElementById('paymentName').value = '';
                document.getElementById('paymentAmount').value = '';
                updateWorkersTable();
            });
    }

    // التقارير
    function showReport() {
        const name = document.getElementById('reportName').value.trim();
        if (!name) {
            showAllReports();
            return;
        }

        const worker = currentProject.workers.find(w => w.name === name);
        if (!worker) {
            document.getElementById('reportsContainer').innerHTML = '<p>العامل غير موجود</p>';
            return;
        }

        displayWorkerReport(worker);
    }

    function showAllReports() {
        const container = document.getElementById('reportsContainer');
        container.innerHTML = '';

        if (!currentProject.workers || currentProject.workers.length === 0) {
            container.innerHTML = '<p>لا يوجد عمال</p>';
            return;
        }

        currentProject.workers.forEach(worker => {
            displayWorkerReport(worker, container);
        });
    }

    function displayWorkerReport(worker, container = null) {
        if (!container) container = document.getElementById('reportsContainer');
        
        const totalDue = (worker.days || 0) * (worker.wage || 0);
        const totalPaid = (worker.payments || []).reduce((sum, p) => sum + p.amount, 0);
        const remaining = totalDue - totalPaid;

        const reportDiv = document.createElement('div');
        reportDiv.className = 'report';
        reportDiv.innerHTML = `
            <h4>${worker.name}</h4>
            <p>📞 ${worker.phone}</p>
            <p>💰 الأجرة: ${worker.wage}</p>
            <p>📅 الأيام: ${worker.days || 0}</p>
            <p>🧾 المستحق: ${totalDue}</p>
            <p>💵 المدفوع: ${totalPaid}</p>
            <p>⚖️ المتبقي: ${remaining}</p>
        `;
        
        if (!container.querySelector(`[data-worker="${worker.name}"]`)) {
            reportDiv.setAttribute('data-worker', worker.name);
            container.appendChild(reportDiv);
        }
    }

    // مشاركة المشروع
    function shareProject() {
        if (!currentProject) return;
        
        const shareUrl = `${window.location.origin}${window.location.pathname}?user=${currentUser.uid}&project=${currentProject.id}`;
        
        if (navigator.share) {
            navigator.share({
                title: currentProject.name,
                url: shareUrl
            });
        } else {
            navigator.clipboard.writeText(shareUrl).then(() => {
                showMessage('تم نسخ الرابط');
            });
        }
    }

    // حذف المشروع
    function deleteProject() {
        if (!currentProject || !confirm('حذف المشروع نهائياً؟')) return;
        
        database.ref(`workmanProjects/${currentUser.uid}/${currentProject.id}`).remove()
            .then(() => {
                showMessage('تم حذف المشروع');
                backToProjects();
            });
    }

    // تحميل مشروع مشارك
    function loadSharedProject(userId, projectId) {
        database.ref(`workmanProjects/${userId}/${projectId}`).once('value', snapshot => {
            const data = snapshot.val();
            if (!data) {
                alert('المشروع غير موجود');
                return;
            }
            
            currentProject = { id: projectId, ...data };
            authPage.classList.add('hidden');
            mainPage.classList.remove('hidden');
            mainPage.style.opacity = '0.9';
            
            document.querySelector('h2').textContent = `مشاهدة: ${currentProject.name}`;
            document.getElementById('projectsList').classList.add('hidden');
            document.getElementById('projectDetails').classList.remove('hidden');
            
            updateWorkersTable();
            showAllReports();
        }).catch(() => {
            alert('خطأ في تحميل المشروع');
        });
    }

    // بدء التطبيق
    window.addEventListener('load', () => {
        if (!checkShareLink()) {
            // التحقق من حالة تسجيل الدخول
        }
    });

</script>

</body>
</html>
