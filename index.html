<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ø¹Ù…Ø§Ù„ - Ù†Ø³Ø®Ø© Ø³Ø±ÙŠØ¹Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body { 
        font-family: 'Cairo', sans-serif;
        direction: rtl; 
        background: #1a1a2e;
        color: #eee;
        padding: 10px; 
        min-height: 100vh;
        line-height: 1.5;
    }
    
    .container { 
        max-width: 800px;
        margin: auto; 
        background: #16213e;
        padding: 20px;
        border-radius: 10px; 
        margin-top: 20px;
    }

    h1, h2, h3 { 
        text-align: center;
        color: #4fc3f7;
        margin-bottom: 15px;
    }

    input, select, textarea { 
        margin: 5px 0;
        padding: 8px; 
        width: 100%; 
        border: 1px solid #333; 
        border-radius: 5px; 
        background: #0f3460;
        color: #fff;
        font-size: 14px;
    }

    button { 
        background: #4fc3f7;
        color: #000;
        cursor: pointer; 
        font-weight: 600;
        margin: 5px 0;
        padding: 10px;
        width: 100%;
        border: none;
        border-radius: 5px;
        font-size: 14px;
    }
    
    button:hover {
        background: #29b6f6;
    }
    
    button.delete {
        background: #f44336;
        color: #fff;
    }
    
    button.delete:hover {
        background: #d32f2f;
    }

    table { 
        width: 100%; 
        border-collapse: collapse;
        margin-top: 15px; 
        font-size: 13px;
    }
    
    th, td { 
        border: 1px solid #333;
        padding: 8px; 
        text-align: center; 
    }
    
    th { 
        background: #0f3460;
    }

    .report { 
        margin-top: 15px;
        padding: 15px; 
        background: #0f3460; 
        border-radius: 8px;
    }

    .project-card {
        background: #0f3460;
        padding: 15px;
        margin: 10px 0;
        cursor: pointer;
        border-radius: 8px;
        border: 1px solid #333;
    }

    .project-card:hover {
        background: #1565c0;
    }

    .hidden {
        display: none;
    }

    .inline-buttons { 
        display: flex;
        gap: 5px; 
    }
    
    .inline-buttons button { 
        flex: 1;
    }

    .success {
        background: #4caf50;
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        text-align: center;
    }

    .error {
        background: #f44336;
        color: #fff;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        text-align: center;
    }

    @media(max-width: 600px) {
        .container {
            padding: 15px;
            margin: 10px 5px;
        }
        
        input, button {
            font-size: 16px; /* Ù…Ù†Ø¹ zoom ÙÙŠ iOS */
        }
        
        table {
            font-size: 12px;
        }
        
        th, td {
            padding: 5px;
        }
    }
</style>
</head>

<body>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="container" id="authPage">
    <h1>ğŸ“‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
    
    <div id="message"></div>

    <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
    
    <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    <button id="signupBtn" style="background: #666;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    
    <p style="text-align: center; margin-top: 15px;">
        <span id="toggleText">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</span> 
        <a href="#" id="toggleLink" style="color: #4fc3f7;">Ø§Ø¶ØºØ· Ù‡Ù†Ø§</a>
    </p>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="container hidden" id="mainPage">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Ù…Ø±Ø­Ø¨Ø§ <span id="userName"></span></h2>
        <button id="logoutBtn" style="width: auto; padding: 8px 15px; background: #666;">Ø®Ø±ÙˆØ¬</button>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ -->
    <div id="projectsList">
        <h2>ğŸ—ï¸ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h2>
        
        <button onclick="showAddProject()">â• Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</button>
        
        <div id="addProjectForm" class="hidden" style="margin: 15px 0; padding: 15px; background: #0f3460; border-radius: 8px;">
            <input type="text" id="newProjectName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
            <div class="inline-buttons">
                <button onclick="addProject()">Ø¥Ø¶Ø§ÙØ©</button>
                <button onclick="hideAddProject()" style="background: #666;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>

        <div id="projectsContainer"></div>
    </div>

    <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ -->
    <div id="projectDetails" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="backToProjects()" style="width: auto; padding: 8px 15px; background: #666;">â† Ø±Ø¬ÙˆØ¹</button>
            <h2 id="projectTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h2>
            <div class="inline-buttons" style="width: auto;">
                <button onclick="shareProject()" style="width: auto; padding: 8px 15px; background: #4caf50;">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                <button onclick="deleteProject()" style="width: auto; padding: 8px 15px;" class="delete">Ø­Ø°Ù</button>
            </div>
        </div>

        <!-- Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ -->
        <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„</h3>
        <input type="text" id="workerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„">
        <input type="number" id="workerPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <input type="number" id="workerWage" placeholder="Ø§Ù„Ø£Ø¬Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©">
        <button onclick="addWorker()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ù„</button>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ø§Ù„ -->
        <h3>ğŸ“Š Ø§Ù„Ø¹Ù…Ø§Ù„</h3>
        <table id="workersTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ø£Ø¬Ø±Ø©</th>
                    <th>Ø§Ù„Ø£ÙŠØ§Ù…</th>
                    <th>Ø§Ù„Ù…Ø³ØªØ­Ù‚</th>
                    <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <!-- Ø§Ù„Ø­Ø¶ÙˆØ± -->
        <h3>ğŸ“ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
        <input type="text" id="attendanceName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„">
        <div class="inline-buttons">
            <button onclick="addAttendance(1)">ÙŠÙˆÙ… ÙƒØ§Ù…Ù„</button>
            <button onclick="addAttendance(0.5)">Ù†ØµÙ ÙŠÙˆÙ…</button>
        </div>

        <!-- Ø§Ù„Ø¯ÙØ¹ -->
        <h3>ğŸ’° Ø¯ÙØ¹ Ø±Ø§ØªØ¨</h3>
        <input type="text" id="paymentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„">
        <input type="number" id="paymentAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <button onclick="makePayment()">Ø¯ÙØ¹</button>

        <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
        <h3>ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
        <input type="text" id="reportName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <div class="inline-buttons">
            <button onclick="showReport()">ØªÙ‚Ø±ÙŠØ± Ù…Ø­Ø¯Ø¯</button>
            <button onclick="showAllReports()">ÙƒÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        </div>
        
        <div id="reportsContainer"></div>
    </div>
</div>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDye4DgqNvEwwWDYf1yjW5yfJc14p1LmiU",
        authDomain: "your-project-10fbe.firebaseapp.com",
        databaseURL: "https://your-project-10fbe-default-rtdb.firebaseio.com",
        projectId: "your-project-10fbe",
        storageBucket: "your-project-10fbe.firebasestorage.app",
        messagingSenderId: "715972050011",
        appId: "1:715972050011:web:d5a4507dcfc30fa779d37e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    
    // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
    let currentUser = null;
    let projects = [];
    let currentProject = null;
    let isViewOnly = false;
    let isLoginMode = true;

    // Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙØ­Ø©
    const authPage = document.getElementById('authPage');
    const mainPage = document.getElementById('mainPage');
    const message = document.getElementById('message');

    // ÙØ­Øµ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
    function checkShareLink() {
        const params = new URLSearchParams(window.location.search);
        const projectId = params.get('project');
        const userId = params.get('user');
        
        if (projectId && userId) {
            isViewOnly = true;
            loadSharedProject(userId, projectId);
            return true;
        }
        return false;
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    auth.onAuthStateChanged(user => {
        if (checkShareLink()) return;
        
        if (user) {
            currentUser = user;
            showMainPage();
            loadProjects();
        } else {
            showAuthPage();
        }
    });

    function showMessage(text, isError = false) {
        message.innerHTML = `<div class="${isError ? 'error' : 'success'}">${text}</div>`;
        setTimeout(() => message.innerHTML = '', 3000);
    }

    function showAuthPage() {
        authPage.classList.remove('hidden');
        mainPage.classList.add('hidden');
    }

    function showMainPage() {
        authPage.classList.add('hidden');
        mainPage.classList.remove('hidden');
        document.getElementById('userName').textContent = currentUser.email.split('@')[0];
    }

    // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„
    document.getElementById('toggleLink').onclick = function(e) {
        e.preventDefault();
        isLoginMode = !isLoginMode;
        
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const toggleText = document.getElementById('toggleText');
        
        if (isLoginMode) {
            loginBtn.style.display = 'block';
            signupBtn.style.display = 'none';
            toggleText.textContent = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ';
        } else {
            loginBtn.style.display = 'none';
            signupBtn.style.display = 'block';
            toggleText.textContent = 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ';
        }
    };

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    document.getElementById('loginBtn').onclick = function() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            showMessage('Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„', true);
            return;
        }

        auth.signInWithEmailAndPassword(email, password)
            .then(() => showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'))
            .catch(() => showMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', true));
    };

    // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
    document.getElementById('signupBtn').onclick = function() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            showMessage('Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„', true);
            return;
        }

        if (password.length < 6) {
            showMessage('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚ØµÙŠØ±Ø©', true);
            return;
        }

        auth.createUserWithEmailAndPassword(email, password)
            .then(() => showMessage('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨'))
            .catch(() => showMessage('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù…', true));
    };

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    document.getElementById('logoutBtn').onclick = function() {
        auth.signOut();
    };

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
    function loadProjects() {
        if (!currentUser) return;
        
        database.ref(`workmanProjects/${currentUser.uid}`).on('value', snapshot => {
            const data = snapshot.val();
            projects = [];
            if (data) {
                projects = Object.keys(data).map(key => ({
                    id: key,
                    ...data[key]
                }));
            }
            displayProjects();
        });
    }

    function displayProjects() {
        const container = document.getElementById('projectsContainer');
        container.innerHTML = '';
        
        if (projects.length === 0) {
            container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹</p>';
            return;
        }

        projects.forEach(p => {
            const workers = p.workers || [];
            const totalWorkers = workers.length;
            const totalOwed = workers.reduce((sum, w) => {
                const due = (w.days || 0) * (w.wage || 0);
                const paid = (w.payments || []).reduce((s, pay) => s + pay.amount, 0);
                return sum + (due - paid);
            }, 0);

            const div = document.createElement('div');
            div.className = 'project-card';
            div.innerHTML = `
                <h3>${p.name}</h3>
                <p>Ø§Ù„Ø¹Ù…Ø§Ù„: ${totalWorkers} | Ø§Ù„Ù…Ø³ØªØ­Ù‚: ${totalOwed.toLocaleString()}</p>
            `;
            div.onclick = () => openProject(p);
            container.appendChild(div);
        });
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹
    function showAddProject() {
        document.getElementById('addProjectForm').classList.remove('hidden');
    }

    function hideAddProject() {
        document.getElementById('addProjectForm').classList.add('hidden');
        document.getElementById('newProjectName').value = '';
    }

    function addProject() {
        const name = document.getElementById('newProjectName').value.trim();
        if (!name) return;

        database.ref(`workmanProjects/${currentUser.uid}`).push({
            name: name,
            workers: []
        }).then(() => {
            showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
            hideAddProject();
        });
    }

    // ÙØªØ­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    function openProject(project) {
        currentProject = project;
        document.getElementById('projectTitle').textContent = project.name;
        document.getElementById('projectsList').classList.add('hidden');
        document.getElementById('projectDetails').classList.remove('hidden');
        updateWorkersTable();
    }

    function backToProjects() {
        if (isViewOnly) {
            window.close();
            return;
        }
        document.getElementById('projectsList').classList.remove('hidden');
        document.getElementById('projectDetails').classList.add('hidden');
        currentProject = null;
    }

    // Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„
    function addWorker() {
        if (!currentProject || isViewOnly) return;

        const name = document.getElementById('workerName').value.trim();
        const phone = document.getElementById('workerPhone').value.trim();
        const wage = parseFloat(document.getElementById('workerWage').value);

        if (!name || !phone || !wage) {
            showMessage('Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„', true);
            return;
        }

        if (!currentProject.workers) currentProject.workers = [];
        currentProject.workers.push({
            name: name,
            phone: phone,
            wage: wage,
            days: 0,
            attendance: [],
            payments: []
        });

        database.ref(`workmanProjects/${currentUser.uid}/${currentProject.id}`).set(currentProject)
            .then(() => {
                showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ù„');
                document.getElementById('workerName').value = '';
                document.getElementById('workerPhone').value = '';
                document.getElementById('workerWage').value = '';
                updateWorkersTable();
            });
    }

    // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ø§Ù„
    function updateWorkersTable() {
        const tbody = document.querySelector('#workersTable tbody');
        tbody.innerHTML = '';

        if (!currentProject.workers) return;

        currentProject.workers.forEach((worker, index) => {
            const totalDue = (worker.days || 0) * (worker.wage || 0);
            const totalPaid = (worker.payments || []).reduce((sum, p) => sum + p.amount, 0);
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${worker.name}</td>
                <td>${worker.wage}</td>
                <td>${worker.days || 0}</td>
                <td>${totalDue}</td>
                <td>
                    ${!isViewOnly ? `<button class="delete" onclick="removeWorker(${index})" style="width: auto; padding: 5px 10px;">Ø­Ø°Ù</button>` : ''}
                </td>
            `;
        });
    }

    // Ø­Ø°Ù Ø¹Ø§Ù…Ù„
    function removeWorker(index) {
        if (confirm('Ø­Ø°Ù Ø§Ù„Ø¹Ø§Ù…Ù„ØŸ')) {
            currentProject.workers.splice(index, 1);
            database.ref(`workmanProjects/${currentUser.uid}/${currentProject.id}`).set(currentProject)
                .then(() => {
                    showMessage('ØªÙ… Ø§Ù„Ø­Ø°Ù');
                    updateWorkersTable();
                });
        }
    }

    // Ø§Ù„Ø­Ø¶ÙˆØ±
    function addAttendance(value) {
        if (isViewOnly) return;
        
        const name = document.getElementById('attendanceName').value.trim();
        if (!name) return;

        const worker = currentProject.workers.find(w => w.name === name);
        if (!worker) {
            showMessage('Ø§Ù„Ø¹Ø§Ù…Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', true);
            return;
        }

        worker.days = (worker.days || 0) + value;
        if (!worker.attendance) worker.attendance = [];
        worker.attendance.push({
            date: new Date().toLocaleDateString(),
            value: value
        });

        database.ref(`workmanProjects/${currentUser.uid}/${currentProject.id}`).set(currentProject)
            .then(() => {
                showMessage(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${value} ÙŠÙˆÙ…`);
                document.getElementById('attendanceName').value = '';
                updateWorkersTable();
            });
    }

    // Ø§Ù„Ø¯ÙØ¹
    function makePayment() {
        if (isViewOnly) return;
        
        const name = document.getElementById('paymentName').value.trim();
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        
        if (!name || !amount) return;

        const worker = currentProject.workers.find(w => w.name === name);
        if (!worker) {
            showMessage('Ø§Ù„Ø¹Ø§Ù…Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', true);
            return;
        }

        if (!worker.payments) worker.payments = [];
        worker.payments.push({
            amount: amount,
            date: new Date().toLocaleDateString()
        });

        database.ref(`workmanProjects/${currentUser.uid}/${currentProject.id}`).set(currentProject)
            .then(() => {
                showMessage('ØªÙ… Ø§Ù„Ø¯ÙØ¹');
                document.getElementById('paymentName').value = '';
                document.getElementById('paymentAmount').value = '';
                updateWorkersTable();
            });
    }

    // Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    function showReport() {
        const name = document.getElementById('reportName').value.trim();
        if (!name) {
            showAllReports();
            return;
        }

        const worker = currentProject.workers.find(w => w.name === name);
        if (!worker) {
            document.getElementById('reportsContainer').innerHTML = '<p>Ø§Ù„Ø¹Ø§Ù…Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</p>';
            return;
        }

        displayWorkerReport(worker);
    }

    function showAllReports() {
        const container = document.getElementById('reportsContainer');
        container.innerHTML = '';

        if (!currentProject.workers || currentProject.workers.length === 0) {
            container.innerHTML = '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ø§Ù„</p>';
            return;
        }

        currentProject.workers.forEach(worker => {
            displayWorkerReport(worker, container);
        });
    }

    function displayWorkerReport(worker, container = null) {
        if (!container) container = document.getElementById('reportsContainer');
        
        const totalDue = (worker.days || 0) * (worker.wage || 0);
        const totalPaid = (worker.payments || []).reduce((sum, p) => sum + p.amount, 0);
        const remaining = totalDue - totalPaid;

        const reportDiv = document.createElement('div');
        reportDiv.className = 'report';
        reportDiv.innerHTML = `
            <h4>${worker.name}</h4>
            <p>ğŸ“ ${worker.phone}</p>
            <p>ğŸ’° Ø§Ù„Ø£Ø¬Ø±Ø©: ${worker.wage}</p>
            <p>ğŸ“… Ø§Ù„Ø£ÙŠØ§Ù…: ${worker.days || 0}</p>
            <p>ğŸ§¾ Ø§Ù„Ù…Ø³ØªØ­Ù‚: ${totalDue}</p>
            <p>ğŸ’µ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: ${totalPaid}</p>
            <p>âš–ï¸ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining}</p>
        `;
        
        if (!container.querySelector(`[data-worker="${worker.name}"]`)) {
            reportDiv.setAttribute('data-worker', worker.name);
            container.appendChild(reportDiv);
        }
    }

    // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    function shareProject() {
        if (!currentProject) return;
        
        const shareUrl = `${window.location.origin}${window.location.pathname}?user=${currentUser.uid}&project=${currentProject.id}`;
        
        if (navigator.share) {
            navigator.share({
                title: currentProject.name,
                url: shareUrl
            });
        } else {
            navigator.clipboard.writeText(shareUrl).then(() => {
                showMessage('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·');
            });
        }
    }

    // Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    function deleteProject() {
        if (!currentProject || !confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
        
        database.ref(`workmanProjects/${currentUser.uid}/${currentProject.id}`).remove()
            .then(() => {
                showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
                backToProjects();
            });
    }

    // ØªØ­Ù…ÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹ Ù…Ø´Ø§Ø±Ùƒ
    function loadSharedProject(userId, projectId) {
        database.ref(`workmanProjects/${userId}/${projectId}`).once('value', snapshot => {
            const data = snapshot.val();
            if (!data) {
                alert('Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                return;
            }
            
            currentProject = { id: projectId, ...data };
            authPage.classList.add('hidden');
            mainPage.classList.remove('hidden');
            mainPage.style.opacity = '0.9';
            
            document.querySelector('h2').textContent = `Ù…Ø´Ø§Ù‡Ø¯Ø©: ${currentProject.name}`;
            document.getElementById('projectsList').classList.add('hidden');
            document.getElementById('projectDetails').classList.remove('hidden');
            
            updateWorkersTable();
            showAllReports();
        }).catch(() => {
            alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
        });
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    window.addEventListener('load', () => {
        if (!checkShareLink()) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        }
    });

</script>

</body>
</html>
