<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“‹ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ø¹Ù…Ø§Ù„</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body { 
        font-family: 'Cairo', sans-serif;
        direction: rtl; 
        background: linear-gradient(135deg, #1f1f2e, #12121c);
        color: #e0e0e0;
        padding: 20px; 
        min-height: 100vh;
        transition: background 0.5s ease, color 0.5s ease;
    }
    
    /* Light Mode */
    body.light-mode {
        background: #f0f0f0;
        color: #111;
    }
    
    body.light-mode .container {
        background: #ffffff;
        border: 1px solid #ccc;
        color: #111;
    }
    
    body.light-mode h1, body.light-mode h2, body.light-mode h3 {
        color: #2193b0;
        -webkit-text-fill-color: #2193b0;
    }
    
    body.light-mode button {
        background: linear-gradient(135deg, #00b09b, #96c93d);
        color: #fff;
    }
    
    body.light-mode input, body.light-mode textarea, body.light-mode select {
        background-color: #fff;
        color: #000;
        border-color: #bbb;
    }
    
    body.light-mode th {
        background: #f8f9fa;
        color: #333;
    }
    
    body.light-mode td {
        color: #333;
    }
    
    /* Theme Toggle */
    .theme-toggle {
        background: none;
        color: #e0e0e0;
        font-size: 1.5rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: none;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1000;
        transition: color 0.3s, background 0.3s;
    }
    
    body.light-mode .theme-toggle {
        color: #2c3e50;
    }
    
    .container { 
        max-width: 900px;
        margin: auto; 
        background: rgba(40, 44, 52, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(6px);
        padding: 40px 35px;
        border-radius: 20px; 
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
        transition: transform 0.4s ease, box-shadow 0.4s ease;
        animation: fadeInUp 0.6s ease-out;
        margin-top: 80px;
    }
    
    .container:hover {
        transform: scale(1.005);
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.5);
    }

    h1, h2, h3 { 
        text-align: center;
        color: #ffffff;
        background: linear-gradient(to right, #6dd5ed, #2193b0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 20px;
    }
    
    h1 {
        font-size: 36px;
        margin-bottom: 25px;
    }

    /* Styles for Inputs */
    input[type="text"], input[type="number"], input[type="email"], input[type="password"], 
    input[type="file"], select, textarea { 
        margin: 5px 0;
        padding: 12px; 
        width: 100%; 
        border: 1px solid #444; 
        border-radius: 10px; 
        box-sizing: border-box;
        background-color: #1d1f27;
        color: #fff;
        font-size: 1rem;
    }
    
    input:focus, textarea:focus, select:focus {
        border-color: #6dd5ed;
        outline: none;
    }

    /* Styles for Buttons */
    button { 
        background: linear-gradient(135deg, #00b09b, #96c93d);
        color: #fff;
        cursor: pointer; 
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 5px 16px rgba(0, 255, 180, 0.3);
        margin: 5px 0;
        padding: 12px;
        width: 100%;
        border: none;
        border-radius: 10px;
        box-sizing: border-box;
        font-size: 1rem;
    }
    
    button:hover {
        background: linear-gradient(135deg, #00816a, #7db515);
        box-shadow: 0 8px 22px rgba(0, 255, 180, 0.4);
        transform: translateY(-1px);
    }
    
    button.delete {
        background: #e74c3c;
        box-shadow: 0 5px 16px rgba(231, 76, 60, 0.3);
    }
    
    button.delete:hover {
        background: #c0392b;
        box-shadow: 0 8px 22px rgba(231, 76, 60, 0.4);
    }

    /* New Button Styles */
    button.back-btn {
        background: linear-gradient(135deg, #8e44ad, #6c3483);
        box-shadow: 0 5px 16px rgba(142, 68, 173, 0.3);
    }
    
    button.back-btn:hover {
        background: linear-gradient(135deg, #7d3c98, #5b2c6f);
        box-shadow: 0 8px 22px rgba(142, 68, 173, 0.4);
    }

    button.share-btn {
        background: linear-gradient(135deg, #3498db, #2980b9);
        box-shadow: 0 5px 16px rgba(52, 152, 219, 0.3);
    }
    
    button.share-btn:hover {
        background: linear-gradient(135deg, #2980b9, #1f6394);
        box-shadow: 0 8px 22px rgba(52, 152, 219, 0.4);
    }

    table { 
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px; 
    }
    
    th, td { 
        border: 1px solid #444;
        padding: 10px; 
        text-align: center; 
    }
    
    th { 
        background: #1d1f27;
        color: #e0e0e0;
    }

    .report { 
        margin-top: 20px;
        padding: 15px;
        background: rgba(40, 44, 52, 0.95); 
        border: 1px solid rgba(255, 255, 255, 0.05); 
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    body.light-mode .report {
        background: #f8f9fa;
        color: #333;
        border: 1px solid #ddd;
    }

    .worker-image { 
        width: 50px;
        height: 50px; 
        border-radius: 50%; 
        object-fit: cover; 
        cursor: pointer; 
    }
    
    .worker-details { 
        display: flex;
        align-items: center; 
        justify-content: center; 
    }
    
    .worker-details img { 
        margin-left: 10px;
    }

    .action-buttons { 
        display: flex; 
        flex-direction: column; 
        align-items: center;
        gap: 5px; 
    }
    
    .inline-buttons { 
        display: flex;
        gap: 5px; 
    }
    
    .inline-buttons button { 
        width: auto;
    }

    /* Project Card Styles */
    .project-card {
        background: rgba(40, 44, 52, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 20px;
        margin: 15px 0;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    body.light-mode .project-card {
        background: #ffffff;
        border: 1px solid #ddd;
        color: #333;
    }

    .project-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        border-color: #6dd5ed;
    }

    .project-card h3 {
        margin: 0;
        color: #6dd5ed;
        font-size: 1.3rem;
    }

    .project-info {
        margin-top: 10px;
        font-size: 0.9rem;
        opacity: 0.8;
    }

    /* New Project Input Section */
    .add-project-section {
        background: rgba(40, 44, 52, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        display: none;
    }

    body.light-mode .add-project-section {
        background: #ffffff;
        border: 1px solid #ddd;
    }

    .add-project-section.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    /* Project Details Header */
    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .project-header h2 {
        margin: 0;
        flex: 1;
    }

    .project-header-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .project-header-buttons button {
        width: auto;
        padding: 10px 20px;
        margin: 0;
        font-size: 0.9rem;
    }

    /* Modal styles */
    .modal { 
        display: none;
        position: fixed; 
        z-index: 1000; 
        padding-top: 100px; 
        left: 0; 
        top: 0; 
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.9);
    }
    
    .modal-content { 
        margin: auto;
        display: block;
        width: 80%;
        max-width: 700px;
    }
    
    .modal-content, #caption { 
        animation-name: zoom;
        animation-duration: 0.6s;
    }
    
    .close { 
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
    }
    
    .close:hover, .close:focus { 
        color: #bbb;
        text-decoration: none;
        cursor: pointer;
    }

    /* Share Modal */
    .share-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
    
    .share-modal-content {
        background-color: rgba(40, 44, 52, 0.95);
        margin: 15% auto;
        padding: 30px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        width: 80%;
        max-width: 500px;
        text-align: center;
        backdrop-filter: blur(6px);
    }
    
    body.light-mode .share-modal-content {
        background-color: #ffffff;
        border: 1px solid #ddd;
        color: #333;
    }

    .share-link {
        background: #1d1f27;
        color: #6dd5ed;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        word-break: break-all;
        border: 1px solid #6dd5ed;
        font-family: monospace;
    }
    
    body.light-mode .share-link {
        background: #f8f9fa;
        color: #2193b0;
        border-color: #2193b0;
    }

    /* Auth Page Styles */
    .auth-container {
        background: rgba(40, 44, 52, 0.95);
        backdrop-filter: blur(6px);
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        width: 100%;
        max-width: 400px;
        text-align: center;
        color: #e0e0e0;
        margin: 80px auto 0;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    body.light-mode .auth-container {
        background: white;
        color: #333;
        border: 1px solid #ccc;
    }
    
    .auth-container h1 {
        color: #ffffff;
        background: linear-gradient(to right, #6dd5ed, #2193b0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 2rem;
        font-size: 1.8rem;
    }
    
    body.light-mode .auth-container h1 {
        color: #333;
        background: none;
        -webkit-text-fill-color: #333;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
        text-align: right;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #e0e0e0;
        font-weight: 500;
    }
    
    body.light-mode .form-group label {
        color: #555;
    }
    
    .form-group input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
        text-align: right;
        background: #1d1f27;
        color: #fff;
    }
    
    body.light-mode .form-group input {
        background: white;
        color: #333;
    }
    
    .form-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .button-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 2rem;
    }
    
    .btn-primary {
        background: #667eea;
        color: white;
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-primary:hover {
        background: #5a67d8;
        transform: translateY(-2px);
    }
    
    .btn-secondary {
        background: #f7f7f7;
        color: #333;
        border: 2px solid #ddd;
        flex: 1;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-secondary:hover {
        background: #e7e7e7;
        transform: translateY(-2px);
    }
    
    .success-message {
        display: none;
        background: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        border: 1px solid #c3e6cb;
    }
    
    .error-message {
        display: none;
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        border: 1px solid #f5c6cb;
    }
    
    .form-toggle {
        margin-top: 1rem;
        color: #666;
    }
    
    .form-toggle a {
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
    }
    
    .form-toggle a:hover {
        text-decoration: underline;
    }
    
    .user-info {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        text-align: right;
        color: #333;
    }
    
    .user-header {
        background: rgba(40, 44, 52, 0.95);
        color: #e0e0e0;
        padding: 10px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }
    
    body.light-mode .user-header {
        background: #ffffff;
        color: #333;
        border: 1px solid #ddd;
    }

    /* Developer Info Footer */
    .developer-info {
        margin-top: 40px;
        text-align: center;
        font-size: 0.9rem;
        color: #888;
        padding: 10px;
        border-top: 1px solid #333;
        width: 100%;
    }
    
    body.light-mode .developer-info {
        color: #555;
        border-top: 1px solid #ccc;
    }
    
    .developer-info a {
        color: #6dd5ed;
        text-decoration: none;
        transition: color 0.3s;
    }
    
    .developer-info a:hover {
        color: #2193b0;
        text-decoration: underline;
    }
    
    /* ğŸ“± ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù‡ÙˆØ§ØªÙ (ØªØ¬Ø§ÙˆØ¨ÙŠ) */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(-40px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideDown { 
        from { opacity: 0; transform: translateY(-20px); } 
        to { opacity: 1; transform: translateY(0); } 
    }
    
    @media(max-width: 600px) and (orientation: portrait) { 
        .flex-between { flex-direction: column; align-items: flex-start; } 
        .button-group { display: flex; flex-direction: column; width: 100%; } 
        .button-group button { width: 100%; margin: 8px 0; } 
        button { width: 100%; margin: 8px 0; } 
        .container { padding: 25px 20px; border-radius: 12px; } 
        h1 { font-size: 26px; } 
        .user-header { flex-direction: column; text-align: center; gap: 10px; } 
        .theme-toggle { top: 10px; left: 10px; font-size: 1.2rem; } 
    } 
    
    #sharePage .flex-between, #sharePage .button-group { 
        display: none !important; 
    } 
    
    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ */ 
    @media (max-width: 768px) { 
        .container { padding: 15px 10px; margin-top: 40px; } 
        h1 { font-size: 22px; } 
        h2, h3 { font-size: 18px; } 
        input, select, textarea, button { font-size: 0.9rem; padding: 8px 10px; } 
        /* ÙŠØ®Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠÙ„Ù ÙŠÙ…ÙŠÙ† ÙˆÙŠØ³Ø§Ø± */ 
        table { display: block; overflow-x: auto; white-space: nowrap; } 
        th, td { font-size: 0.85rem; padding: 6px; } 
        /* ÙŠØ®Ù„ÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶ */ 
        .inline-buttons { flex-direction: column; } 
        .inline-buttons button { width: 100%; } 
    }

    /* Tracking Page Styles */
    .tracking-page {
        display: none;
    }
    
    .tracking-page.show {
        display: block;
        animation: fadeInUp 0.6s ease-out;
    }
    
    .day-details {
        margin-top: 15px;
        display: none;
        background: #22262b;
        padding: 10px;
        border-radius: 8px;
    }
    
    img, video {
        max-width: 100px;
        max-height: 100px;
        border-radius: 8px;
        margin: 5px;
        cursor: pointer;
        border: 2px solid #ddd;
        transition: transform 0.2s, border-color 0.2s;
    }
    
    img:hover, video:hover {
        transform: scale(1.05);
        border-color: #3498db;
    }
    
    .fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .fullscreen img, .fullscreen video {
        max-width: 90%;
        max-height: 90%;
        border-radius: 0;
    }

    /* Progress bar */
    .progress-bar {
        background: #1d1f27;
        border-radius: 8px;
        height: 25px;
        margin: 15px 0;
        overflow: hidden;
    }
    
    .progress {
        background: linear-gradient(to right, #00b09b, #96c93d);
        height: 100%;
        border-radius: 8px;
        width: 0%;
        color: white;
        text-align: center;
        line-height: 25px;
        font-size: 14px;
        transition: width 0.5s ease-in-out;
    }
    
    .hidden {
        display: none;
    }
    
    .flex-between {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

</style>
</head>
<body>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

<div id="darkModeToggle" class="theme-toggle">
    <i class="fas fa-adjust"></i>
</div>

<div class="auth-container" id="authPage">
    <div class="icon">ğŸ“‹</div>
    <h1 id="form-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
    <div id="success-msg" class="success-message"></div>
    <div id="error-msg" class="error-message"></div>
    <form id="auth-form">
        <div class="form-group">
            <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
            <input type="email" id="email" name="email" placeholder="Your-Name@gmail.com" required>
        </div>
        <div class="form-group">
            <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
            <input type="password" id="password" name="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
            <a href="#" style="font-size: 0.9rem; color: #667eea; text-decoration: underline; display: block; text-align: right; margin-top: 10px;" onclick="resetPassword(); return false;" id="forgot-password-link">Ù‡Ù„ Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a>
        </div>
        <div class="form-group hidden" id="confirm-password-group">
            <label for="confirm-password">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
            <input type="password" id="confirm-password" name="confirm-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div class="button-group">
            <button type="submit" id="submit-btn" class="btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <button type="button" id="toggle-auth-btn" class="btn-secondary">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
        </div>
    </form>
    <p class="form-toggle">
        <span id="form-toggle-text">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</span>
        <a href="#" id="form-toggle-link">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a>
    </p>
</div>

<div class="container hidden" id="mainApp">
    <div class="user-header">
        <h2 id="userName"></h2>
        <button id="logoutBtn" class="delete">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <h1>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ø¹Ù…Ø§Ù„</h1>

    <div id="projectsPage">
        <div class="flex-between">
            <input type="text" id="projectSearchInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø´Ø±ÙˆØ¹...">
            <div class="inline-buttons">
                <button onclick="showAddProjectForm()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹</button>
                <button onclick="showReportPage()">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ±</button>
            </div>
        </div>
        
        <div id="projects-list"></div>
    </div>

    <div class="add-project-section" id="addProjectSection">
        <h2 id="project-form-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</h2>
        <form id="projectForm">
            <input type="hidden" id="projectId">
            <input type="text" id="projectName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" required>
            <textarea id="projectDetails" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"></textarea>
            <input type="number" id="projectBudget" placeholder="Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹" min="0">
            <div class="inline-buttons">
                <button type="submit" id="addProjectBtn">Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
                <button type="button" class="delete" onclick="hideAddProjectForm()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </form>
    </div>

    <div id="projectDetailsPage" class="hidden">
        <div class="project-header">
            <button class="back-btn" onclick="showProjectsPage()"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            <h2 id="currentProjectName"></h2>
            <div class="project-header-buttons">
                <button id="addWorkerBtn" onclick="showAddWorkerForm()">+ Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„</button>
                <button class="share-btn" id="shareProjectBtn" onclick="showShareModal()"><i class="fas fa-share-alt"></i> Ù…Ø´Ø§Ø±ÙƒØ©</button>
                <button class="delete" id="deleteProjectBtn" onclick="deleteCurrentProject()"><i class="fas fa-trash-alt"></i> Ø­Ø°Ù</button>
            </div>
        </div>
        
        <div class="project-info">
            <p><strong>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:</strong> <span id="projectBudgetDisplay"></span></p>
            <p><strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> <span id="projectDetailsDisplay"></span></p>
            <div class="progress-bar">
                <div class="progress" id="project-progress"></div>
            </div>
        </div>

        <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ø§Ù„</h3>
        <table>
            <thead>
                <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th>
                    <th>ØµÙˆØ±/ÙÙŠØ¯ÙŠÙˆ</th>
                    <th>Ø§Ù„Ø±Ø§ØªØ¨</th>
                    <th>Ø§Ù„Ø¯ÙØ¹Ø§Øª</th>
                    <th>Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù†Ø¬Ø²</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="workersTableBody">
                </tbody>
        </table>

        <div id="addWorkerSection" class="add-project-section">
            <h3 id="worker-form-title">Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯</h3>
            <form id="workerForm">
                <input type="hidden" id="workerIndex">
                <input type="text" id="workerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„" required>
                <input type="number" id="workerSalary" placeholder="Ø§Ù„Ø±Ø§ØªØ¨ (Ø¨Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©)" min="0" required>
                <input type="file" id="workerMedia" accept="image/*,video/*" multiple>
                <button type="submit">Ø­ÙØ¸ Ø§Ù„Ø¹Ø§Ù…Ù„</button>
                <button type="button" class="delete" onclick="hideAddWorkerForm()">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
        </div>
    </div>
    
    <div id="trackingPage" class="tracking-page hidden">
        <button class="back-btn" onclick="showProjectsPage()"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        <h2>ØªØªØ¨Ø¹ ÙŠÙˆÙ…ÙŠ</h2>
        <input type="text" id="searchDayInput" placeholder="Ø¨Ø­Ø« Ø¹Ù† ÙŠÙˆÙ…...">
        <button onclick="addDailyRecord()">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ÙŠÙˆÙ…ÙŠ</button>
        <div id="dailyRecordsList"></div>
    </div>

    <div id="dayDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDayDetailsModal()">&times;</span>
            <h3 id="dayDetailsDate"></h3>
            <textarea id="dayDetailsTextarea" rows="5" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…..."></textarea>
            <input type="file" id="dayDetailsMedia" accept="image/*,video/*" multiple>
            <div id="dayDetailsMediaContainer"></div>
            <button onclick="saveDayDetails()">Ø­ÙØ¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
        </div>
    </div>
    
    <div id="fullscreenModal" class="fullscreen hidden">
        <span class="close" onclick="closeFullscreenModal()">&times;</span>
        <img id="fullscreenImage" style="display: none;">
        <video id="fullscreenVideo" controls style="display: none;"></video>
    </div>

    <div id="reportsPage" class="hidden">
        <button class="back-btn" onclick="showProjectsPage()"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        <h1>ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h1>
        
        <div class="report">
            <h3>ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h3>
            <div id="projectProgressReport"></div>
        </div>

        <div class="report">
            <h3>ØªÙ‚Ø§Ø±ÙŠØ± Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ø§Ù„</h3>
            <p>Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¬Ù„ Ø¯ÙØ¹Ø§Øª Ø¹Ø§Ù…Ù„ Ù…Ø¹ÙŠÙ†:</p>
            <input type="text" id="historyWorkerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„">
            <button onclick="showPaymentHistory()">Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</button>
            <div id="paymentHistoryReport"></div>
        </div>
    </div>

    <div id="shareModal" class="share-modal">
        <div class="share-modal-content">
            <span class="close" onclick="closeShareModal()">&times;</span>
            <h3>Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
            <p>Ø´Ø§Ø±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø´Ø®Øµ Ø¢Ø®Ø± Ù„Ù…Ù†Ø­Ù‡ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·.</p>
            <div class="share-link" id="shareLink"></div>
            <button onclick="copyShareLink()">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
        </div>
    </div>

    <div class="developer-info">
        <p>
            ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© <a href="#" target="_blank">Abo Al-wafa</a> | Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©
        </p>
    </div>

</div>

<script>
    // Firebase configuration (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase)
    const firebaseConfig = {
        // Your Firebase config (Ø£Ø¶Ù Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ù‡Ù†Ø§)
    };
    
    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const database = firebase.database();
    
    // DOM Elements
    const authPage = document.getElementById('authPage');
    const mainApp = document.getElementById('mainApp');
    const formTitle = document.getElementById('form-title');
    const authForm = document.getElementById('auth-form');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInputGroup = document.getElementById('confirm-password-group');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const submitBtn = document.getElementById('submit-btn');
    const toggleAuthBtn = document.getElementById('toggle-auth-btn');
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    const formToggleText = document.getElementById('form-toggle-text');
    const formToggleLink = document.getElementById('form-toggle-link');
    const successMsg = document.getElementById('success-msg');
    const errorMsg = document.getElementById('error-msg');
    const userNameElement = document.getElementById('userName');
    const logoutBtn = document.getElementById('logoutBtn');
    
    const projectsPage = document.getElementById('projectsPage');
    const projectsList = document.getElementById('projects-list');
    const projectSearchInput = document.getElementById('projectSearchInput');
    
    const addProjectSection = document.getElementById('addProjectSection');
    const projectForm = document.getElementById('projectForm');
    const projectIdInput = document.getElementById('projectId');
    const projectNameInput = document.getElementById('projectName');
    const projectDetailsInput = document.getElementById('projectDetails');
    const projectBudgetInput = document.getElementById('projectBudget');
    
    const projectDetailsPage = document.getElementById('projectDetailsPage');
    const currentProjectName = document.getElementById('currentProjectName');
    const projectBudgetDisplay = document.getElementById('projectBudgetDisplay');
    const projectDetailsDisplay = document.getElementById('projectDetailsDisplay');
    const workersTableBody = document.getElementById('workersTableBody');
    const addWorkerSection = document.getElementById('addWorkerSection');
    const workerForm = document.getElementById('workerForm');
    const workerIndexInput = document.getElementById('workerIndex');
    const workerNameInput = document.getElementById('workerName');
    const workerSalaryInput = document.getElementById('workerSalary');
    const workerMediaInput = document.getElementById('workerMedia');
    const projectProgressElement = document.getElementById('project-progress');
    
    const reportsPage = document.getElementById('reportsPage');
    const projectProgressReportDiv = document.getElementById('projectProgressReport');
    const historyWorkerNameInput = document.getElementById('historyWorkerName');
    const paymentHistoryReportDiv = document.getElementById('paymentHistoryReport');

    const shareModal = document.getElementById('shareModal');
    const shareLinkDiv = document.getElementById('shareLink');
    const shareProjectBtn = document.getElementById('shareProjectBtn');

    // Tracking page elements
    const trackingPage = document.getElementById('trackingPage');
    const dailyRecordsList = document.getElementById('dailyRecordsList');
    const searchDayInput = document.getElementById('searchDayInput');
    const dayDetailsModal = document.getElementById('dayDetailsModal');
    const dayDetailsDate = document.getElementById('dayDetailsDate');
    const dayDetailsTextarea = document.getElementById('dayDetailsTextarea');
    const dayDetailsMediaInput = document.getElementById('dayDetailsMedia');
    const dayDetailsMediaContainer = document.getElementById('dayDetailsMediaContainer');
    const fullscreenModal = document.getElementById('fullscreenModal');
    const fullscreenImage = document.getElementById('fullscreenImage');
    const fullscreenVideo = document.getElementById('fullscreenVideo');
    
    let currentProject = null;
    let userId = null;
    let isViewOnly = false;
    
    // UI state management
    function showPage(pageId) {
        const pages = [authPage, mainApp, projectsPage, projectDetailsPage, reportsPage, trackingPage];
        pages.forEach(page => page.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
    }

    function showProjectsPage() {
        showPage('mainApp');
        projectsPage.classList.remove('hidden');
        projectDetailsPage.classList.add('hidden');
        reportsPage.classList.add('hidden');
        trackingPage.classList.add('hidden');
        hideAddProjectForm();
        updateProjectsList();
    }
    
    function showProjectDetailsPage(project) {
        currentProject = project;
        showPage('mainApp');
        projectsPage.classList.add('hidden');
        projectDetailsPage.classList.remove('hidden');
        reportsPage.classList.add('hidden');
        trackingPage.classList.add('hidden');
        
        currentProjectName.textContent = project.name;
        projectBudgetDisplay.textContent = formatNumber(project.budget);
        projectDetailsDisplay.textContent = project.details;
        
        document.getElementById('addWorkerBtn').style.display = isViewOnly ? 'none' : 'inline-block';
        document.getElementById('deleteProjectBtn').style.display = isViewOnly ? 'none' : 'inline-block';
        
        updateTable();
    }

    function showReportPage() {
        showPage('mainApp');
        projectsPage.classList.add('hidden');
        projectDetailsPage.classList.add('hidden');
        reportsPage.classList.remove('hidden');
        trackingPage.classList.add('hidden');
        updateProjectProgressReport();
    }
    
    function showTrackingPage() {
        showPage('mainApp');
        projectsPage.classList.add('hidden');
        projectDetailsPage.classList.add('hidden');
        reportsPage.classList.add('hidden');
        trackingPage.classList.remove('hidden');
        displayDailyRecords();
    }

    function showAddProjectForm() {
        addProjectSection.classList.add('show');
        projectForm.reset();
        document.getElementById('project-form-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯';
        projectIdInput.value = '';
    }
    
    function hideAddProjectForm() {
        addProjectSection.classList.remove('show');
    }

    function showAddWorkerForm() {
        addWorkerSection.classList.add('show');
        workerForm.reset();
        document.getElementById('worker-form-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯';
        workerIndexInput.value = '';
    }
    
    function hideAddWorkerForm() {
        addWorkerSection.classList.remove('show');
    }
    
    function showShareModal() {
        if (!currentProject) return;
        shareLinkDiv.textContent = `${window.location.origin}${window.location.pathname}?view=${currentProject.id}`;
        shareModal.style.display = 'block';
    }
    
    function closeShareModal() {
        shareModal.style.display = 'none';
    }
    
    function showFullscreenModal(src, type) {
        if (type.startsWith('image')) {
            fullscreenImage.src = src;
            fullscreenImage.style.display = 'block';
            fullscreenVideo.style.display = 'none';
        } else if (type.startsWith('video')) {
            fullscreenVideo.src = src;
            fullscreenVideo.style.display = 'block';
            fullscreenImage.style.display = 'none';
        }
        fullscreenModal.classList.remove('hidden');
    }
    
    function closeFullscreenModal() {
        fullscreenModal.classList.add('hidden');
        fullscreenVideo.pause();
    }

    // Firebase database functions
    function getDbRef() {
        if (isViewOnly) {
            const projectId = window.location.search.split('view=')[1];
            return database.ref(`shared-projects/${projectId}`);
        } else {
            return database.ref(`users/${userId}/projects`);
        }
    }
    
    function saveProject(project) {
        if (isViewOnly) return Promise.resolve();
        const ref = getDbRef();
        if (project.id) {
            return ref.child(project.id).update(project);
        } else {
            const newRef = ref.push();
            project.id = newRef.key;
            return newRef.set(project);
        }
    }

    function deleteProject(projectId) {
        if (isViewOnly) return;
        return getDbRef().child(projectId).remove();
    }

    function getProjects() {
        return new Promise((resolve, reject) => {
            getDbRef().once('value', snapshot => {
                const projects = [];
                snapshot.forEach(childSnapshot => {
                    projects.push(childSnapshot.val());
                });
                resolve(projects);
            }).catch(reject);
        });
    }

    // UI update functions
    function updateProjectsList(filter = '') {
        getProjects().then(projects => {
            projectsList.innerHTML = '';
            const filteredProjects = projects.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
            
            if (filteredProjects.length === 0) {
                projectsList.innerHTML = `<p style="text-align: center; margin-top: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.</p>`;
                return;
            }
            
            filteredProjects.forEach(project => {
                const card = document.createElement('div');
                card.className = 'project-card';
                card.innerHTML = `
                    <h3>${project.name}</h3>
                    <div class="project-info">
                        <p><strong>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©:</strong> ${formatNumber(project.budget)}</p>
                        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ù„:</strong> ${project.workers ? project.workers.length : 0}</p>
                    </div>
                `;
                card.onclick = () => showProjectDetailsPage(project);
                projectsList.appendChild(card);
            });
        }).catch(error => {
            console.error("Error fetching projects: ", error);
        });
    }

    function updateTable() {
        if (!currentProject) return;
        const workers = currentProject.workers || [];
        workersTableBody.innerHTML = '';
        
        workers.forEach((worker, index) => {
            const paymentsTotal = worker.payments ? worker.payments.reduce((sum, p) => sum + p.amount, 0) : 0;
            const remainingPayment = worker.salary - paymentsTotal;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${worker.name}</td>
                <td class="worker-details">
                    ${worker.media ? worker.media.map(m => `
                        <img src="${m.url}" class="worker-image" onclick="showFullscreenModal('${m.url}', '${m.type}')" alt="Worker Media">
                    `).join('') : '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>'}
                </td>
                <td>${formatNumber(worker.salary)}</td>
                <td>${formatNumber(paymentsTotal)}</td>
                <td>${formatNumber(remainingPayment)}</td>
                <td>
                    <div class="action-buttons">
                        <button onclick="payWorker(${index})">Ø¯ÙØ¹</button>
                        <button onclick="editWorker(${index})">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="delete" onclick="deleteWorker(${index})">Ø­Ø°Ù</button>
                    </div>
                </td>
            `;
            workersTableBody.appendChild(row);
        });
        updateProjectProgress();
    }
    
    function updateProjectProgress() {
        if (!currentProject || !currentProject.workers) {
            projectProgressElement.style.width = '0%';
            projectProgressElement.textContent = '0%';
            return;
        }
        
        const totalSalary = currentProject.workers.reduce((sum, w) => sum + (w.salary || 0), 0);
        const totalPayments = currentProject.workers.reduce((sum, w) => {
            const payments = w.payments || [];
            return sum + payments.reduce((pSum, p) => pSum + (p.amount || 0), 0);
        }, 0);
        
        const progress = totalSalary > 0 ? (totalPayments / totalSalary) * 100 : 0;
        projectProgressElement.style.width = `${Math.min(100, progress)}%`;
        projectProgressElement.textContent = `${Math.min(100, progress).toFixed(1)}%`;
    }

    function updateProjectProgressReport() {
        getProjects().then(projects => {
            projectProgressReportDiv.innerHTML = '';
            if (projects.length === 0) {
                projectProgressReportDiv.innerHTML = `<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.</p>`;
                return;
            }
            
            projects.forEach(project => {
                const totalSalary = project.workers ? project.workers.reduce((sum, w) => sum + (w.salary || 0), 0) : 0;
                const totalPayments = project.workers ? project.workers.reduce((sum, w) => {
                    const payments = w.payments || [];
                    return sum + payments.reduce((pSum, p) => pSum + (p.amount || 0), 0);
                }, 0) : 0;
                
                const progress = totalSalary > 0 ? (totalPayments / totalSalary) * 100 : 0;
                
                const reportCard = document.createElement('div');
                reportCard.className = 'project-card';
                reportCard.innerHTML = `
                    <h3>${project.name}</h3>
                    <div class="progress-bar">
                        <div class="progress" style="width: ${Math.min(100, progress)}%;">
                            ${Math.min(100, progress).toFixed(1)}%
                        </div>
                    </div>
                    <p>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${formatNumber(project.budget)}</p>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: ${formatNumber(totalPayments)}</p>
                `;
                projectProgressReportDiv.appendChild(reportCard);
            });
        });
    }

    function showPaymentHistory() {
        let historyDiv = document.getElementById("paymentHistoryReport");
        let nameToFind = document.getElementById("historyWorkerName").value.trim();
        let workers = getWorkers();
        
        if (!historyDiv) return;
        historyDiv.innerHTML = "";

        let worker = workers.find(w => w.name === nameToFind);
        if (worker) {
            if (worker.payments && worker.payments.length > 0) {
                let reportHTML = `<h4>Ø³Ø¬Ù„ Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„: ${worker.name}</h4><ul>`;
                worker.payments.forEach(p => {
                    reportHTML += `<li>Ù…Ø¨Ù„Øº: ${formatNumber(p.amount)} | Ø§Ù„ØªØ§Ø±ÙŠØ®: ${p.date}</li>`;
                });
                reportHTML += `</ul>`;
                historyDiv.innerHTML = reportHTML;
            } else {
                historyDiv.innerHTML = `<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…Ù„.</p>`;
            }
        } else {
            historyDiv.innerHTML = `<p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ø§Ù…Ù„ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù….</p>`;
        }
    }
    
    // Utility functions
    function formatNumber(num) {
        return num ? num.toLocaleString('ar-SA') : '0';
    }
    
    function copyShareLink() {
        const link = shareLinkDiv.textContent;
        navigator.clipboard.writeText(link).then(() => {
            alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!');
        }).catch(err => {
            console.error('Failed to copy: ', err);
        });
    }

    // Auth functions
    function handleAuth(event) {
        event.preventDefault();
        const email = emailInput.value;
        const password = passwordInput.value;
        
        if (submitBtn.textContent === 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„') {
            auth.signInWithEmailAndPassword(email, password).catch(handleAuthError);
        } else {
            const confirmPassword = confirmPasswordInput.value;
            if (password !== confirmPassword) {
                showError('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.');
                return;
            }
            auth.createUserWithEmailAndPassword(email, password).catch(handleAuthError);
        }
    }
    
    function handleAuthError(error) {
        let message = 'Ø­Ø¯Ø« Ø®Ø·Ø£. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        switch(error.code) {
            case 'auth/email-already-in-use':
                message = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„.';
                break;
            case 'auth/invalid-email':
                message = 'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                break;
            case 'auth/weak-password':
                message = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©. ÙŠØ¬Ø¨ Ø£Ù† ØªØªÙƒÙˆÙ† Ù…Ù† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
                break;
            case 'auth/user-not-found':
            case 'auth/wrong-password':
                message = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
                break;
        }
        showError(message);
    }

    function resetPassword() {
        const email = emailInput.value;
        if (!email) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£ÙˆÙ„Ø§Ù‹.');
            return;
        }
        auth.sendPasswordResetEmail(email)
            .then(() => {
                showSuccess('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.');
            })
            .catch(handleAuthError);
    }
    
    function showSuccess(message) {
        successMsg.textContent = message;
        successMsg.style.display = 'block';
        errorMsg.style.display = 'none';
    }
    
    function showError(message) {
        errorMsg.textContent = message;
        errorMsg.style.display = 'block';
        successMsg.style.display = 'none';
    }
    
    function toggleAuthMode() {
        if (submitBtn.textContent === 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„') {
            formTitle.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯';
            submitBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
            toggleAuthBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            formToggleText.textContent = 'Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ';
            formToggleLink.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            confirmPasswordInputGroup.classList.remove('hidden');
            forgotPasswordLink.style.display = 'none';
        } else {
            formTitle.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
            toggleAuthBtn.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
            formToggleText.textContent = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ';
            formToggleLink.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨';
            confirmPasswordInputGroup.classList.add('hidden');
            forgotPasswordLink.style.display = 'block';
        }
        showError('');
        showSuccess('');
    }
    
    // Auth state listener
    auth.onAuthStateChanged(user => {
        if (user) {
            userId = user.uid;
            checkViewOnlyMode();
        } else {
            showPage('authPage');
            userId = null;
        }
    });

    function checkViewOnlyMode() {
        const urlParams = new URLSearchParams(window.location.search);
        const viewId = urlParams.get('view');
        if (viewId) {
            isViewOnly = true;
            shareProjectBtn.classList.add('hidden');
            getDbRef().once('value', snapshot => {
                const project = snapshot.val();
                if (project) {
                    currentProject = project;
                    showProjectDetailsPage(project);
                } else {
                    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.');
                    window.location.href = window.location.origin + window.location.pathname;
                }
            });
        } else {
            isViewOnly = false;
            if (userId) {
                showProjectsPage();
                shareProjectBtn.classList.remove('hidden');
            }
        }
    }
    
    // Project management functions
    projectForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const projectName = projectNameInput.value;
        const projectDetails = projectDetailsInput.value;
        const projectBudget = parseFloat(projectBudgetInput.value) || 0;
        
        let project = {
            id: projectIdInput.value,
            name: projectName,
            details: projectDetails,
            budget: projectBudget,
            workers: currentProject ? currentProject.workers : []
        };
        
        try {
            await saveProject(project);
            hideAddProjectForm();
            updateProjectsList();
        } catch (error) {
            console.error("Error saving project: ", error);
        }
    });

    function deleteCurrentProject() {
        if (isViewOnly) return;
        if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ø´Ø±ÙˆØ¹ "${currentProject.name}"ØŸ`)) {
            deleteProject(currentProject.id).then(() => {
                showProjectsPage();
            });
        }
    }

    // Worker management functions
    workerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isViewOnly) return;
        
        const workerName = workerNameInput.value;
        const workerSalary = parseFloat(workerSalaryInput.value) || 0;
        const workerMediaFiles = workerMediaInput.files;
        
        let workers = currentProject.workers || [];
        
        const worker = {
            name: workerName,
            salary: workerSalary,
            media: [],
            payments: []
        };
        
        if (workerMediaFiles.length > 0) {
            // Placeholder for media upload logic
            // In a real app, you would upload files to a service like Firebase Storage
            // For this example, we'll create simple object URLs
            for (let i = 0; i < workerMediaFiles.length; i++) {
                const file = workerMediaFiles[i];
                const fileURL = URL.createObjectURL(file);
                worker.media.push({
                    url: fileURL,
                    type: file.type
                });
            }
        }

        const workerIndex = workerIndexInput.value;
        if (workerIndex !== '') {
            workers[workerIndex] = worker;
        } else {
            workers.push(worker);
        }
        
        currentProject.workers = workers;
        await saveProject(currentProject);
        
        hideAddWorkerForm();
        updateTable();
    });

    function editWorker(index) {
        if (isViewOnly) return;
        const worker = currentProject.workers[index];
        workerNameInput.value = worker.name;
        workerSalaryInput.value = worker.salary;
        workerIndexInput.value = index;
        document.getElementById('worker-form-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„';
        showAddWorkerForm();
    }

    function deleteWorker(index) {
        if (isViewOnly) return;
        
        let workers = getWorkers();
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…Ù„ØŸ")) {
            workers.splice(index, 1);
            currentProject.workers = workers;
            saveProject(currentProject).then(() => {
                updateTable();
            });
        }
    }

    function payWorker(index) {
        if (isViewOnly) return;
        const worker = currentProject.workers[index];
        const amount = prompt(`ÙƒÙ… ØªØ±ÙŠØ¯ Ø£Ù† ØªØ¯ÙØ¹ Ù„Ù„Ø¹Ø§Ù…Ù„ ${worker.name}ØŸ`);
        
        if (amount && !isNaN(amount) && amount > 0) {
            const payments = worker.payments || [];
            payments.push({
                amount: parseFloat(amount),
                date: new Date().toLocaleDateString('ar-SA')
            });
            worker.payments = payments;
            saveProject(currentProject).then(() => {
                updateTable();
            });
        }
    }

    // Tracking functions
    function addDailyRecord() {
        const today = new Date().toLocaleDateString('ar-SA');
        let records = currentProject.dailyRecords || [];
        
        // Check if a record for today already exists
        const existingRecord = records.find(record => record.date === today);
        if (existingRecord) {
            alert('ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„.');
            return;
        }

        records.unshift({
            date: today,
            details: '',
            media: []
        });
        
        currentProject.dailyRecords = records;
        saveProject(currentProject).then(() => {
            displayDailyRecords();
        });
    }

    function displayDailyRecords(filter = '') {
        const records = currentProject.dailyRecords || [];
        dailyRecordsList.innerHTML = '';
        const filteredRecords = records.filter(record => record.date.includes(filter) || record.details.includes(filter));
        
        if (filteredRecords.length === 0) {
            dailyRecordsList.innerHTML = `<p style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ÙŠÙˆÙ…ÙŠØ© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.</p>`;
            return;
        }
        
        filteredRecords.forEach((record, index) => {
            const dayCard = document.createElement('div');
            dayCard.className = 'day';
            dayCard.innerHTML = `
                <div class="flex-between">
                    <h3>Ø³Ø¬Ù„ ÙŠÙˆÙ… ${record.date}</h3>
                    <div class="inline-buttons">
                        <button onclick="viewDayDetails(${index})">Ø¹Ø±Ø¶</button>
                        <button class="delete" onclick="deleteDailyRecord(${index})">Ø­Ø°Ù</button>
                    </div>
                </div>
            `;
            dailyRecordsList.appendChild(dayCard);
        });
    }
    
    function viewDayDetails(index) {
        const record = currentProject.dailyRecords[index];
        dayDetailsDate.textContent = `Ø³Ø¬Ù„ ÙŠÙˆÙ… ${record.date}`;
        dayDetailsTextarea.value = record.details;
        dayDetailsMediaContainer.innerHTML = '';
        
        record.media.forEach(m => {
            if (m.type.startsWith('image')) {
                const img = document.createElement('img');
                img.src = m.url;
                img.onclick = () => showFullscreenModal(m.url, m.type);
                dayDetailsMediaContainer.appendChild(img);
            } else if (m.type.startsWith('video')) {
                const video = document.createElement('video');
                video.src = m.url;
                video.onclick = () => showFullscreenModal(m.url, m.type);
                video.controls = true;
                dayDetailsMediaContainer.appendChild(video);
            }
        });
        
        dayDetailsModal.dataset.recordIndex = index;
        dayDetailsModal.style.display = 'block';
    }
    
    function closeDayDetailsModal() {
        dayDetailsModal.style.display = 'none';
    }
    
    async function saveDayDetails() {
        const index = dayDetailsModal.dataset.recordIndex;
        const record = currentProject.dailyRecords[index];
        record.details = dayDetailsTextarea.value;
        
        const mediaFiles = dayDetailsMediaInput.files;
        for (let i = 0; i < mediaFiles.length; i++) {
            const file = mediaFiles[i];
            const fileURL = URL.createObjectURL(file);
            record.media.push({
                url: fileURL,
                type: file.type
            });
        }
        
        await saveProject(currentProject);
        closeDayDetailsModal();
        displayDailyRecords();
    }
    
    function deleteDailyRecord(index) {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠØŸ')) {
            currentProject.dailyRecords.splice(index, 1);
            saveProject(currentProject).then(() => {
                displayDailyRecords();
            });
        }
    }

    // Event Listeners
    authForm.addEventListener('submit', handleAuth);
    toggleAuthBtn.addEventListener('click', toggleAuthMode);
    formToggleLink.addEventListener('click', (e) => {
        e.preventDefault();
        toggleAuthMode();
    });
    
    logoutBtn.addEventListener('click', () => {
        auth.signOut();
    });

    projectSearchInput.addEventListener('input', (e) => {
        updateProjectsList(e.target.value);
    });

    searchDayInput.addEventListener('input', (e) => {
        displayDailyRecords(e.target.value);
    });

    // Dark Mode Toggle
    document.addEventListener('DOMContentLoaded', (event) => {
        const darkModeToggle = document.getElementById('darkModeToggle');
        const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

        const currentTheme = localStorage.getItem("theme");
        if (currentTheme === "dark") {
            document.body.classList.remove("light-mode");
        } else if (currentTheme === "light") {
            document.body.classList.add("light-mode");
        } else if (prefersDarkScheme.matches) {
            document.body.classList.remove("light-mode");
        } else {
            document.body.classList.add("light-mode");
        }
        
        function updateDarkModeIcon() {
            if (document.body.classList.contains("light-mode")) {
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                darkModeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }
        
        updateDarkModeIcon();
        
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle("light-mode");
            if (document.body.classList.contains("light-mode")) {
                localStorage.setItem("theme", "light");
            } else {
                localStorage.setItem("theme", "dark");
            }
            updateDarkModeIcon();
        });
    });

</script>
</body>
</html>
